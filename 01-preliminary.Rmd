---
title: "Hawaii Collection Trip Preliminary Analysis"
author: "Dan Cook"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: united
    toc: yes
  pdf_document: 
    toc: yes
---

```{r setup, include=FALSE}
require(knitr)
library(leaflet)
# devtools::install_github("wch/webshot")
library(webshot)
library(tidyverse)
opts_knit$set(progress=TRUE)

opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE, print=FALSE)
opts_chunk$set(results="asis")
opts_chunk$set(cache=TRUE,cache.path="cache/")
opts_chunk$set(fig.path="figure/",dev=c("png", "svg"))
opts_chunk$set(debug = function(before, options, envir) {
  if (!before) {
    message(
      paste(names(envir), as.list(envir),
            sep = " = ", collapse = "\n"))
  }
})

gallery <- function(df) {
    knitr::asis_output(paste0("<img class='img-thumbnail' src='", df$photo_url_thumb, "' />"))
}


WIDTH <- 20
HEIGHT <- 20
  
ICONS <- iconList(
  RED = makeIcon(
    iconUrl = "https://storage.googleapis.com/andersenlab.org/img/red.svg",
    iconWidth = WIDTH, iconHeight = HEIGHT,
    popupAnchorX = 0.00001, popupAnchorY = -HEIGHT+13,
    iconAnchorX = WIDTH/2, iconAnchorY = HEIGHT),
  BLUE = makeIcon(
    iconUrl = "https://storage.googleapis.com/andersenlab.org/img/blue.svg",
    iconWidth = WIDTH, iconHeight = HEIGHT,
    popupAnchorX = 0.00001, popupAnchorY = -HEIGHT+13,
    iconAnchorX = WIDTH/2, iconAnchorY = HEIGHT)
)

map_collection <- function(df, by) {
  
  leaflet::leaflet(data = df) %>% 
      leaflet::addTiles( 
      paste0( 
        "https://{s}.tile.thunderforest.com/cycle/{z}/{x}/{y}.png?apikey=", 
        jsonlite::read_json("thunderforest.json")$key)  
      ) %>%
    leaflet::addMarkers(~longitude, ~latitude, popup = df$c_label, 
               icon = ~ICONS['RED'] )
  
  #htmlwidgets::saveWidget(m, tempfile(), selfcontained = FALSE)
  #webshot::webshot("temp.html", file = "map.png",
  #        cliprect = "viewport", vwidth = 1000, vheight = 1000)
  
}


# Load Data
load("data/df.Rda")

```

# Overall Summary

```{r leaflet, echo = FALSE}

map_collection(df)

library(maps)

county <- map_data("world") %>% filter(region == 'USA', subregion == "Hawaii")

ggplot() +  
    geom_polygon(data=county, aes(x=long, y=lat, group=group), fill="grey40", 
        colour="grey90", alpha=1) +
    labs(x="", y="", title="Building Area Within 1000m") + #labels
    theme(axis.ticks.y = element_blank(),axis.text.y = element_blank(), # get rid of x ticks/text
          axis.ticks.x = element_blank(),axis.text.x = element_blank(), # get rid of y ticks/text
          plot.title = element_text(lineheight=.8, face="bold", vjust=1)) + # make title bold and add space
    geom_point(aes(x=longitude, y=latitude), data=df, alpha=1, size=3, color="grey20") + # to get outline
    geom_point(aes(x=longitude, y=latitude), data=df, alpha=1, size=2, color="red") +
    scale_colour_gradientn("Building\narea (sq-km)", 
        colours=c( "#f9f3c2","#660000"))+
    coord_equal(ratio=1)# change color scale

```

## Island Summary

```{r island_summary}

knitr::kable(summary)

```

## C-label Summary

```{r overall_summary}

cso %>%
  dplyr::group_by(c_label) %>%
  dplyr::mutate(n = n()) %>%
  dplyr::ungroup() %>%
  dplyr::summarize(c_label_count = length(unique(c_label)),
                   s_label_count = mean(n()),
                   s_labels_per_plate = mean(n)) %>%
  knitr::kable()

```

# Variable Summaries

## Substrate Moisture

```{r substrate_moisture}

ggplot(df) +
  geom_histogram(aes(x = substrate_moisture_)) +
  labs(x = "Substrate Moisture (%)", y = "Count") +
  facet_grid(substrate_moisture_issue~.) +
  theme_bw()

```

* On Tuesday (2017-08-08) we discovered that the moisture meter output varies depending on the mode that was set. The histogram above displays values based on those that have these issues.

## Substrate Temperature

```{r substrate_temperature}

ggplot(df) +
  geom_histogram(aes(x = substrate_temperature_c), bins=50) +
  labs(x = "Substrate Temperature (C)", y = "Count") +
  theme_bw()

```

* Substrate temperature < 9 and == 100 NA'd

## Ambient Humidty

```{r ambient_humidity}

ggplot(df) +
  geom_histogram(aes(x = ambient_humidity_), bins=50) +
  labs(x = "Ambient Humidity (%)", y = "Count") +
  theme_bw()

```

```{r ambient_temperature_c}

ggplot(df) +
  geom_histogram(aes(x = ambient_temperature_c), bins=30) +
  labs(x = "Ambient Temperature (C)", y = "Count") +
  theme_bw()

```


## Daily Collections

```{r 2017-08-02}

  
```

## Gallery

```{r gallery, results='asis', include=TRUE}
gallery(df %>% dplyr::filter(substrate == "Flower"))
```


